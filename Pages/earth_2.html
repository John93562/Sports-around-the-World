<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Interactive 3D-like Earth with D3.js</title>
    <style>
      body {
        margin: 0;
      }
      canvas {
        display: block;
      }
    </style>
  </head>
  <body>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/topojson.v1.min.js"></script>
    <script>
      // Set up canvas and context
      const width = window.innerWidth;
      const height = window.innerHeight;
      const canvas = d3
        .select("body")
        .append("canvas")
        .attr("width", width)
        .attr("height", height)
        .node();
      const context = canvas.getContext("2d");

      // Set up the globe projection
      const projection = d3
        .geoOrthographic()
        .scale(250)
        .translate([width / 2, height / 2])
        .precision(0.1);

      const path = d3.geoPath(projection, context);

      // Add water
      context.beginPath();
      path({ type: "Sphere" });
      context.fillStyle = "#181236";
      context.fill();

      // Load and draw the map
      d3.json("https://unpkg.com/world-atlas@1/world/110m.json").then(
        (worldData) => {
          const land = topojson.feature(worldData, worldData.objects.land);
          const countries = topojson.feature(
            worldData,
            worldData.objects.countries
          ).features;

          drawMap(land, countries);

          // Add drag behavior
          d3
            .drag()
            .subject(() => {
              const r = projection.rotate();
              return { x: r[0] / sensitivity, y: -r[1] / sensitivity };
            })
            .on("drag", (event) => {
              const rotate = projection.rotate();
              console.log(event);
              projection.rotate([
                event.x * sensitivity,
                -event.y * sensitivity,
                rotate[2],
              ]);
              drawMap(land, countries);
            })(d3.select(canvas));

          // Handle window resize
          window.addEventListener("resize", () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            projection.translate([canvas.width / 2, canvas.height / 2]);
            drawMap(land, countries);
          });
        }
      );

      const sensitivity = 0.25;

      function drawMap(land, countries) {
        context.clearRect(0, 0, width, height);

        // Draw water
        context.beginPath();
        path({ type: "Sphere" });
        context.fillStyle = "#181236";
        context.fill();

        // Draw land
        context.beginPath();
        path(land);
        context.fillStyle = "#F19BFE";
        context.fill();

        // Draw country borders
        context.beginPath();
        path({ type: "FeatureCollection", features: countries });
        context.strokeStyle = "#F6C1BC";
        context.lineWidth = 0.5;
        context.stroke();
      }
    </script>
  </body>
</html>
